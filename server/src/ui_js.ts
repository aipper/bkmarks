import { js as baseJs } from './ui'

function replaceOnce(source: string, search: string, replacement: string) {
  const idx = source.indexOf(search)
  if (idx === -1) return { value: source, replaced: false }
  return { value: source.replace(search, replacement), replaced: true }
}

export function js() {
  let out = baseJs()

  const confirmSnippet =
    "let confirmInit=false;let confirmState=null;function confirmEls(){return{modal:document.getElementById('confirmModal'),backdrop:document.getElementById('confirmBackdrop'),close:document.getElementById('confirmClose'),cancel:document.getElementById('confirmCancel'),ok:document.getElementById('confirmOk'),title:document.getElementById('confirmTitle'),subtitle:document.getElementById('confirmSubtitle'),body:document.getElementById('confirmBody')}}function closeConfirm(){const el=confirmEls();if(el.modal)el.modal.classList.add('hidden');document.body.classList.remove('modal-open');confirmState=null}function ensureConfirm(){if(confirmInit)return;confirmInit=true;const el=confirmEls();if(!el.modal)return;const close=()=>closeConfirm();[el.backdrop,el.close,el.cancel].forEach((b)=>b&&b.addEventListener('click',close));if(el.ok)el.ok.addEventListener('click',async()=>{const st=confirmState;if(!st||st.busy)return;st.busy=true;const okText=st.okText||'确定';const loadingText=st.loadingText||'处理中…';if(el.ok){el.ok.disabled=true;el.ok.textContent=loadingText}try{if(typeof st.onOk==='function')await st.onOk();closeConfirm()}catch{alert('操作失败');closeConfirm()}finally{if(el.ok){el.ok.disabled=false;el.ok.textContent=okText}st.busy=false}});document.addEventListener('keydown',(e)=>{if(e.key==='Escape'&&confirmState)closeConfirm()})}function openConfirm(opts){ensureConfirm();const el=confirmEls();if(!el.modal)return;confirmState={...opts,busy:false};if(el.title)el.title.textContent=opts.title||'确认操作';if(el.subtitle)el.subtitle.textContent=opts.subtitle||'';if(el.ok){el.ok.textContent=opts.okText||'确定';el.ok.classList.toggle('danger',!!opts.danger)}if(el.body){el.body.innerHTML='';if(opts.body){const d=document.createElement('div');d.textContent=opts.body;el.body.appendChild(d)}if(opts.hint){const h=document.createElement('div');h.className='confirm-hint';h.textContent=opts.hint;el.body.appendChild(h)}}document.body.classList.add('modal-open');el.modal.classList.remove('hidden')}"

  const batchSnippet =
    "let batchAiBusy=false;function setBatchAiInfo(t){const el=document.getElementById('batchAiInfo');if(el)el.textContent=t||''}async function batchAi(btn){if(batchAiBusy)return;const q=((elSearch&&elSearch.value)||'').toLowerCase();const filtered=items.filter(it=>{const inTag=activeTag==='全部'||(it.tags||[]).includes(activeTag);const str=(it.title||'')+' '+(it.url||'');const inSearch=str.toLowerCase().includes(q);return inTag&&inSearch});const todo=filtered.filter(it=>!it.aiCheckedAt);if(!todo.length){setBatchAiInfo('暂无待识别');return}openConfirm({title:'批量AI识别',subtitle:`范围：当前筛选（${todo.length}条未识别）`,body:'将对未识别的书签逐条调用 AI 分类。',hint:'可能消耗配额；已识别的不会重复识别。',okText:'开始',loadingText:'开始中…',onOk:async()=>{batchAiBusy=true;const original=(btn&&btn.textContent)||'批量AI识别';if(btn){btn.disabled=true}let ok=0;let skipped=0;let failed=0;let limited=0;for(let i=0;i<todo.length;i++){const it=todo[i];if(btn)btn.textContent=`识别中 ${i+1}/${todo.length}`;try{const r=await fetch('/api/ai/classify',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({url:it.url,title:it.title||''})});if(r.status===429){limited=todo.length-i;break}if(!r.ok){failed++;continue}const j=await r.json();if(j&&j.skipped)skipped++;else ok++}catch{failed++}}if(btn){btn.disabled=false;btn.textContent=original}batchAiBusy=false;await fetchItems();const parts=[];if(ok)parts.push(`成功${ok}`);if(skipped)parts.push(`跳过${skipped}`);if(failed)parts.push(`失败${failed}`);if(limited)parts.push(`配额不足剩余${limited}`);setBatchAiInfo(parts.length?`批量识别：${parts.join('，')}`:'批量识别完成')}})}document.addEventListener('click',(e)=>{const t=e.target;const btn=t&&t.closest?t.closest('#batchAiBtn'):null;if(!btn)return;e.preventDefault();e.stopPropagation();batchAi(btn)});"

  const delCode =
    "const delBtn=document.createElement('button');delBtn.type='button';delBtn.className='ai-btn danger';delBtn.textContent='删除';delBtn.addEventListener('click',(e)=>{e.preventDefault();e.stopPropagation();openConfirm({title:'删除书签？',subtitle:it.title||it.url,body:(host||it.url),hint:'仅删除服务器记录，本地 Chrome 书签不受影响；扩展“全量同步”会自动跳过该 URL。',okText:'删除',loadingText:'删除中…',danger:true,onOk:async()=>{const r=await fetch('/api/bookmarks/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({url:it.url})});if(!r.ok)throw new Error('bad');await fetchItems()}})});"

  out = replaceOnce(
    out,
    "finally{if(el.save)el.save.disabled=false}}function ensureTagEditor(){",
    "finally{if(el.save)el.save.disabled=false}}" + confirmSnippet + batchSnippet + 'function ensureTagEditor(){'
  ).value

  out = replaceOnce(
    out,
    "card.addEventListener('keydown',(e)=>{if(e.key==='Enter')window.open(it.url,'_blank')});",
    "card.addEventListener('keydown',(e)=>{if(e.target.closest('.ai-btn'))return;if(e.key==='Enter')window.open(it.url,'_blank')});"
  ).value

  const aiBlock =
    "if(it.aiCheckedAt){aiBtn.textContent='已识别';aiBtn.disabled=true}else{aiBtn.textContent='AI识别';aiBtn.addEventListener('click',(e)=>{e.preventDefault();e.stopPropagation();runAi(it,aiBtn)})}"
  out = replaceOnce(out, aiBlock, aiBlock + delCode).value

  out = replaceOnce(
    out,
    'meta.appendChild(u);meta.appendChild(st);meta.appendChild(editBtn);meta.appendChild(aiBtn);',
    'meta.appendChild(u);meta.appendChild(st);meta.appendChild(editBtn);meta.appendChild(aiBtn);meta.appendChild(delBtn);'
  ).value

  out = replaceOnce(
    out,
    '<div class="user-menu" role="menu"><a class="menu-item" href="/app/profile">个人中心</a>',
    '<div class="user-menu" role="menu"><a class="menu-item" href="/app">书签主页</a><a class="menu-item" href="/app/profile">个人中心</a>'
  ).value

  out = replaceOnce(
    out,
    "const nav=[{id:'profile',label:'个人中心',href:'/app/profile'},{id:'settings',label:'系统设置',href:'/app/settings'},{id:'status',label:'系统状态',href:'/app/status'},{id:'tags',label:'标签管理',href:'/app/tags'}];",
    "const nav=[{id:'bookmarks',label:'书签主页',href:'/app'},{id:'profile',label:'个人中心',href:'/app/profile'},{id:'settings',label:'系统设置',href:'/app/settings'},{id:'status',label:'系统状态',href:'/app/status'},{id:'tags',label:'标签管理',href:'/app/tags'}];"
  ).value

  const aiConfigSnippet = "let aiConfigBusy=false;function setAiConfigStatus(msg,type){const el=document.getElementById('aiConfigStatus');if(!el)return;el.textContent=msg||'';el.className='config-status '+(type||'')}function setAiNotice(msg){const el=document.getElementById('aiMigrationNotice');if(!el)return;if(!msg){el.classList.add('hidden');el.textContent='';return}el.textContent=msg;el.classList.remove('hidden')}function clearProbeResults(){const el=document.getElementById('aiProbeResults');if(!el)return;el.textContent=''}function renderProbeResults(results){const el=document.getElementById('aiProbeResults');if(!el)return;el.innerHTML='';if(!results||!results.length){const d=document.createElement('div');d.style.color='#64748b';d.style.fontSize='12px';d.textContent='暂无探测结果';el.appendChild(d);return}results.forEach((r)=>{const row=document.createElement('div');row.className='probe-row '+(r.ok?'ok':'fail');const p=document.createElement('div');p.className='probe-provider';p.textContent=(r.provider||'').toString();const st=document.createElement('div');st.className='probe-status';st.textContent=r.ok?'OK':'FAIL';const lat=document.createElement('div');lat.className='probe-latency';lat.textContent=(typeof r.latencyMs==='number'?`${r.latencyMs}ms`:'-');const err=document.createElement('div');err.className='probe-error';err.textContent=(r.ok?'':(r.error||''))||'';row.appendChild(p);row.appendChild(st);row.appendChild(lat);row.appendChild(err);el.appendChild(row)})}function onAiProviderChange(){const provider=document.getElementById('aiProvider')?.value||'';const openaiConfig=document.getElementById('openaiConfig');const geminiConfig=document.getElementById('geminiConfig');if(openaiConfig)openaiConfig.classList.toggle('hidden',provider!=='openai'&&provider!=='openai_compatible');if(geminiConfig)geminiConfig.classList.toggle('hidden',provider!=='gemini');const testBtn=document.getElementById('aiTestBtn');if(testBtn)testBtn.disabled=!provider||provider==='none';if(!provider||provider==='none'){setAiConfigStatus('AI 未启用（请选择 Provider）','')} }async function loadAiConfig(){try{setAiNotice('');const r=await fetch('/api/admin/ai-config');if(!r.ok)return;const j=await r.json();if(!j.ok)return;const config=j.config||{};if(j.needsReselect){setAiNotice(j.message||'检测到历史 Workers AI 配置，已迁移为未启用。请重新选择 Provider。')}const providerEl=document.getElementById('aiProvider');const openaiModelEl=document.getElementById('openaiModel');const openaiBaseUrlEl=document.getElementById('openaiBaseUrl');const geminiModelEl=document.getElementById('geminiModel');if(providerEl)providerEl.value=config.provider||'none';if(openaiModelEl)openaiModelEl.value=config.openaiModel||'';if(openaiBaseUrlEl)openaiBaseUrlEl.value=config.openaiBaseUrl||'';if(geminiModelEl)geminiModelEl.value=config.geminiModel||'';onAiProviderChange();setAiConfigStatus('配置已加载','success');clearProbeResults()}catch{setAiConfigStatus('加载配置失败','error')}}async function testAiConnection(){if(aiConfigBusy)return;const provider=(document.getElementById('aiProvider')?.value||'none').trim();if(!provider||provider==='none'){setAiConfigStatus('未启用 AI：请选择 Provider 后再测试','error');onAiProviderChange();return}aiConfigBusy=true;const btn=document.getElementById('aiTestBtn');const original=btn?.textContent||'测试连接';if(btn){btn.disabled=true;btn.textContent='测试中…'}setAiConfigStatus('正在测试连接…','loading');try{const openaiApiKey=(document.getElementById('openaiApiKey')?.value||'').trim();const openaiModel=(document.getElementById('openaiModel')?.value||'').trim();const openaiBaseUrl=(document.getElementById('openaiBaseUrl')?.value||'').trim();const geminiApiKey=(document.getElementById('geminiApiKey')?.value||'').trim();const geminiModel=(document.getElementById('geminiModel')?.value||'').trim();const cand={provider};if(provider==='openai'||provider==='openai_compatible'){if(openaiModel)cand.openaiModel=openaiModel;if(openaiBaseUrl)cand.openaiBaseUrl=openaiBaseUrl;if(openaiApiKey)cand.openaiApiKey=openaiApiKey}if(provider==='gemini'){if(geminiModel)cand.geminiModel=geminiModel;if(geminiApiKey)cand.geminiApiKey=geminiApiKey}const r=await fetch('/api/admin/ai-config/test/batch',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({includeNone:false,candidates:[cand]})});const j=await r.json();const res=(j&&j.results&&j.results[0])||null;if(!j||!j.ok||!res){setAiConfigStatus('连接失败：请求异常','error')}else if(res.ok){setAiConfigStatus('连接成功！','success')}else{const err=(res.error||'未知错误');const msg=(err==='api_key_missing')?'缺少 API Key':(err==='not_configured')?'未启用 AI':err;setAiConfigStatus('连接失败：'+msg,'error')}renderProbeResults(j.results||[])}catch{setAiConfigStatus('连接失败：网络错误','error')}finally{if(btn){btn.disabled=false;btn.textContent=original}aiConfigBusy=false;onAiProviderChange()}}async function batchProbe(){if(aiConfigBusy)return;aiConfigBusy=true;const btn=document.getElementById('aiBatchProbeBtn');const original=btn?.textContent||'批量探测';if(btn){btn.disabled=true;btn.textContent='探测中…'}setAiConfigStatus('正在批量探测…','loading');try{const openaiApiKey=(document.getElementById('openaiApiKey')?.value||'').trim();const openaiModel=(document.getElementById('openaiModel')?.value||'').trim();const openaiBaseUrl=(document.getElementById('openaiBaseUrl')?.value||'').trim();const geminiApiKey=(document.getElementById('geminiApiKey')?.value||'').trim();const geminiModel=(document.getElementById('geminiModel')?.value||'').trim();const cands=[{provider:'openai'},{provider:'openai_compatible'},{provider:'gemini'},{provider:'none'}];if(openaiModel){cands[0].openaiModel=openaiModel;cands[1].openaiModel=openaiModel}if(openaiBaseUrl){cands[0].openaiBaseUrl=openaiBaseUrl;cands[1].openaiBaseUrl=openaiBaseUrl}if(openaiApiKey){cands[0].openaiApiKey=openaiApiKey;cands[1].openaiApiKey=openaiApiKey}if(geminiModel){cands[2].geminiModel=geminiModel}if(geminiApiKey){cands[2].geminiApiKey=geminiApiKey}const r=await fetch('/api/admin/ai-config/test/batch',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({includeNone:true,candidates:cands})});if(r.status===403){setAiConfigStatus('无权限：仅管理员可探测','error');return}const j=await r.json();if(!j.ok){setAiConfigStatus('探测失败','error');return}renderProbeResults(j.results||[]);const ok=(j.summary&&j.summary.ok)||0;const failed=(j.summary&&j.summary.failed)||0;setAiConfigStatus(`批量探测完成：成功${ok}，失败${failed}`,(failed? 'error':'success'))}catch{setAiConfigStatus('探测失败：网络错误','error')}finally{if(btn){btn.disabled=false;btn.textContent=original}aiConfigBusy=false;onAiProviderChange()}}async function saveAiConfig(){if(aiConfigBusy)return;aiConfigBusy=true;const btn=document.getElementById('aiSaveBtn');const original=btn?.textContent||'保存配置';if(btn){btn.disabled=true;btn.textContent='保存中…'}setAiConfigStatus('正在保存配置…','loading');try{const provider=document.getElementById('aiProvider')?.value||'none';const openaiApiKey=document.getElementById('openaiApiKey')?.value||'';const openaiModel=document.getElementById('openaiModel')?.value||'';const openaiBaseUrl=document.getElementById('openaiBaseUrl')?.value||'';const geminiApiKey=document.getElementById('geminiApiKey')?.value||'';const geminiModel=document.getElementById('geminiModel')?.value||'';const payload={provider};if(provider==='openai'||provider==='openai_compatible'){payload.openaiModel=(openaiModel||'gpt-4o-mini');payload.openaiBaseUrl=(openaiBaseUrl||'https://api.openai.com/v1');if(openaiApiKey.trim())payload.openaiApiKey=openaiApiKey.trim()}if(provider==='gemini'){payload.geminiModel=(geminiModel||'gemini-1.5-flash');if(geminiApiKey.trim())payload.geminiApiKey=geminiApiKey.trim()}const r=await fetch('/api/admin/ai-config',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});if(r.ok){setAiConfigStatus('配置已保存！','success')}else{setAiConfigStatus('保存失败','error')}}catch{setAiConfigStatus('保存失败：网络错误','error')}finally{if(btn){btn.disabled=false;btn.textContent=original}aiConfigBusy=false;onAiProviderChange()}}document.addEventListener('DOMContentLoaded',()=>{const providerEl=document.getElementById('aiProvider');if(providerEl)providerEl.addEventListener('change',onAiProviderChange);const testBtn=document.getElementById('aiTestBtn');if(testBtn)testBtn.addEventListener('click',testAiConnection);const batchBtn=document.getElementById('aiBatchProbeBtn');if(batchBtn)batchBtn.addEventListener('click',batchProbe);const saveBtn=document.getElementById('aiSaveBtn');if(saveBtn)saveBtn.addEventListener('click',saveAiConfig);const settingsView=document.getElementById('settingsView');if(settingsView){const observer=new MutationObserver((mutations)=>{mutations.forEach((m)=>{if(m.target===settingsView&&!settingsView.classList.contains('hidden')){loadAiConfig()}})});observer.observe(settingsView,{attributes:true,attributeFilter:['class']})}});"

  const aiLimitsSnippet = "let aiLimitsBusy=false;function setAiLimitsStatus(msg,type){const el=document.getElementById('aiLimitsStatus');if(!el)return;el.textContent=msg||'';el.className='config-status '+(type||'')}async function loadAiLimits(){try{const r=await fetch('/api/admin/ai-limits');if(!r.ok)return;const j=await r.json();if(!j||!j.ok)return;const lim=j.limits||{};const dg=document.getElementById('aiDailyGlobal');const du=document.getElementById('aiDailyPerUser');const rg=document.getElementById('aiRpmGlobal');if(dg)dg.value=(lim.dailyGlobal??'');if(du)du.value=(lim.dailyPerUser??'');if(rg)rg.value=(lim.rpmGlobal??'');setAiLimitsStatus('限额已加载','success')}catch{setAiLimitsStatus('加载限额失败','error')}}async function saveAiLimits(){if(aiLimitsBusy)return;aiLimitsBusy=true;const btn=document.getElementById('aiLimitsSaveBtn');const original=btn?.textContent||'保存限额';if(btn){btn.disabled=true;btn.textContent='保存中…'}setAiLimitsStatus('正在保存限额…','loading');try{const dg=document.getElementById('aiDailyGlobal')?.value;const du=document.getElementById('aiDailyPerUser')?.value;const rg=document.getElementById('aiRpmGlobal')?.value;const payload={dailyGlobal:Number(dg),dailyPerUser:Number(du),rpmGlobal:Number(rg)};const r=await fetch('/api/admin/ai-limits',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});if(!r.ok){setAiLimitsStatus('保存失败','error');return}const j=await r.json();if(j&&j.ok){setAiLimitsStatus('限额已保存！','success')}else{setAiLimitsStatus('保存失败','error')}}catch{setAiLimitsStatus('保存失败：网络错误','error')}finally{if(btn){btn.disabled=false;btn.textContent=original}aiLimitsBusy=false}}document.addEventListener('DOMContentLoaded',()=>{const save=document.getElementById('aiLimitsSaveBtn');if(save)save.addEventListener('click',saveAiLimits);const settingsView=document.getElementById('settingsView');if(settingsView){const observer=new MutationObserver((mutations)=>{mutations.forEach((m)=>{if(m.target===settingsView&&!settingsView.classList.contains('hidden')){loadAiLimits()}})});observer.observe(settingsView,{attributes:true,attributeFilter:['class']})}});"

  out = replaceOnce(
    out,
    "document.addEventListener('click',(e)=>{const t=e.target;const btn=t&&t.closest?t.closest('#batchAiBtn'):null;if(!btn)return;e.preventDefault();e.stopPropagation();batchAi(btn)});",
    "document.addEventListener('click',(e)=>{const t=e.target;const btn=t&&t.closest?t.closest('#batchAiBtn'):null;if(!btn)return;e.preventDefault();e.stopPropagation();batchAi(btn)});" + aiConfigSnippet + aiLimitsSnippet
  ).value

  return out
}
